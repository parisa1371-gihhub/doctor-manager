{% extends 'base.html' %}
{% load static %}

{% block title %}ویرایش بیمار - {{ patient.full_name }} - سیستم مدیریت بیماران{% endblock %}
{% block page_title %}ویرایش بیمار{% endblock %}
{% block page_subtitle %}ویرایش اطلاعات {{ patient.full_name }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Patient Info Card -->
    <div class="bg-gradient-to-r from-medical-500 to-medical-600 rounded-2xl p-6 text-white mb-8">
        <div class="flex items-center space-x-4 space-x-reverse">
            <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                <i data-lucide="user" class="w-8 h-8 text-white"></i>
            </div>
            <div>
                <h2 class="text-2xl font-bold">{{ patient.full_name }}</h2>
                <p class="text-medical-100">ویرایش اطلاعات شخصی</p>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="text-xl font-semibold text-gray-800 flex items-center">
                <i data-lucide="edit" class="w-6 h-6 ml-2 text-medical-600"></i>
                ویرایش اطلاعات بیمار
            </h3>
            <p class="text-gray-600 mt-2">اطلاعات بیمار را ویرایش کنید</p>
        </div>

        <form method="post" class="space-y-8" id="patientForm">
            {% csrf_token %}
            
            <!-- Personal Information Section -->
            <div class="bg-gradient-to-r from-medical-50 to-medical-100 rounded-xl p-6 border border-medical-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-6 flex items-center">
                    <div class="w-8 h-8 bg-medical-600 rounded-lg flex items-center justify-center ml-3">
                        <i data-lucide="user" class="w-5 h-5 text-white"></i>
                    </div>
                    اطلاعات شخصی
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- First Name -->
                    <div class="form-group">
                        <label for="{{ form.first_name.id_for_label }}" class="form-label">
                            <i data-lucide="user" class="w-4 h-4 ml-2 text-medical-600"></i>
                            نام *
                        </label>
                        {{ form.first_name }}
                        {% if form.first_name.errors %}
                            <div class="mt-2 text-sm text-red-600 flex items-center">
                                <i data-lucide="alert-circle" class="w-4 h-4 ml-1"></i>
                                {% for error in form.first_name.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Last Name -->
                    <div class="form-group">
                        <label for="{{ form.last_name.id_for_label }}" class="form-label">
                            <i data-lucide="user" class="w-4 h-4 ml-2 text-medical-600"></i>
                            نام خانوادگی *
                        </label>
                        {{ form.last_name }}
                        {% if form.last_name.errors %}
                            <div class="mt-2 text-sm text-red-600 flex items-center">
                                <i data-lucide="alert-circle" class="w-4 h-4 ml-1"></i>
                                {% for error in form.last_name.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- National ID -->
                    <div class="form-group">
                        <label for="{{ form.national_id.id_for_label }}" class="form-label">
                            <i data-lucide="id-card" class="w-4 h-4 ml-2 text-medical-600"></i>
                            کد ملی *
                        </label>
                        {{ form.national_id }}
                        {% if form.national_id.errors %}
                            <div class="mt-2 text-sm text-red-600 flex items-center">
                                <i data-lucide="alert-circle" class="w-4 h-4 ml-1"></i>
                                {% for error in form.national_id.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Birth Date -->
                    <div class="form-group">
                        <label for="birth_date" class="form-label">
                            <i data-lucide="calendar" class="w-4 h-4 ml-2 text-medical-600"></i>
                            تاریخ تولد *
                        </label>
                        {{ form.birth_date }}
                        {% if form.birth_date.errors %}
                            <div class="mt-2 text-sm text-red-600 flex items-center">
                                <i data-lucide="alert-circle" class="w-4 h-4 ml-1"></i>
                                {% for error in form.birth_date.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-group">
                    <!-- Gender -->
                    <label for="{{ form.gender.id_for_label }}" class="form-label">
                        <i data-lucide="users" class="w-4 h-4 ml-2 text-medical-600"></i>
                        جنسیت *
                    </label>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        {% for choice in form.gender %}
                            {% if choice.data.value == 'M' or choice.data.value == 'F' %}
                            <label class="gender-option flex items-center justify-center p-4 border-2 border-gray-300 rounded-xl cursor-pointer hover:border-medical-300 hover:bg-medical-50 transition-all duration-200 {% if choice.data.value == form.gender.value %}bg-medical-50 border-medical-500{% endif %}">
                                <input type="radio" name="{{ form.gender.name }}" value="{{ choice.data.value }}" 
                                       class="sr-only" {% if choice.data.value == form.gender.value %}checked{% endif %}>
                                <div class="flex flex-col items-center">
                                    <i data-lucide="user" class="w-6 h-6 mb-2 text-gray-600"></i>
                                    <span class="text-sm font-medium text-gray-700">
                                        {% if choice.data.value == 'M' %}مرد{% else %}زن{% endif %}
                                    </span>
                                </div>
                            </label>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% if form.gender.errors %}
                        <div class="mt-2 text-sm text-red-600 flex items-center">
                            <i data-lucide="alert-circle" class="w-4 h-4 ml-1"></i>
                            {% for error in form.gender.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Contact Information Section -->
            <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-6 flex items-center">
                    <div class="w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center ml-3">
                        <i data-lucide="phone" class="w-5 h-5 text-white"></i>
                    </div>
                    اطلاعات تماس
                </h3>
                
                <!-- Phone -->
                <div class="form-group">
                    <label for="{{ form.phone.id_for_label }}" class="form-label">
                        <i data-lucide="phone" class="w-4 h-4 ml-2 text-green-600"></i>
                        شماره تلفن *
                    </label>
                    {{ form.phone }}
                    {% if form.phone.errors %}
                        <div class="mt-2 text-sm text-red-600 flex items-center">
                            <i data-lucide="alert-circle" class="w-4 h-4 ml-1"></i>
                            {% for error in form.phone.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <!-- Address -->
                <div class="form-group">
                    <label for="{{ form.address.id_for_label }}" class="form-label">
                        <i data-lucide="map-pin" class="w-4 h-4 ml-2 text-green-600"></i>
                        آدرس *
                    </label>
                    {{ form.address }}
                    {% if form.address.errors %}
                        <div class="mt-2 text-sm text-red-600 flex items-center">
                            <i data-lucide="alert-circle" class="w-4 h-4 ml-1"></i>
                            {% for error in form.address.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="flex flex-col sm:flex-row gap-4 pt-8 border-t border-gray-200">
                <button type="submit" class="btn-primary flex-1 sm:flex-none">
                    <i data-lucide="save" class="w-5 h-5 ml-2"></i>
                    ذخیره تغییرات
                </button>
                
                <a href="{% url 'patient_detail' patient.id %}" class="btn-secondary flex-1 sm:flex-none text-center">
                    <i data-lucide="arrow-left" class="w-5 h-5 ml-2"></i>
                    بازگشت به جزئیات بیمار
                </a>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
// Enhanced form functionality
document.addEventListener('DOMContentLoaded', function() {
    // Style all form inputs
    const inputs = document.querySelectorAll('input[type="text"], input[type="date"], input[type="tel"], textarea');
    inputs.forEach(input => {
        input.classList.add('form-input');
    });
    
    // Handle gender radio button styling
    const genderRadios = document.querySelectorAll('input[name="gender"]');
    genderRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            // Remove active styling from all labels
            document.querySelectorAll('.gender-option').forEach(label => {
                label.classList.remove('bg-medical-50', 'border-medical-500');
                label.classList.add('border-gray-300');
            });
            
            // Add active styling to selected label
            if (this.checked) {
                const label = this.closest('.gender-option');
                label.classList.add('bg-medical-50', 'border-medical-500');
                label.classList.remove('border-gray-300');
            }
        });
    });
    
    // Initialize gender radio styling
    const checkedGender = document.querySelector('input[name="gender"]:checked');
    if (checkedGender) {
        const label = checkedGender.closest('.gender-option');
        label.classList.add('bg-medical-50', 'border-medical-500');
        label.classList.remove('border-gray-300');
    }
    
    // Form validation
    const form = document.getElementById('patientForm');
    form.addEventListener('submit', function(e) {
        const requiredFields = form.querySelectorAll('input[required], textarea[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('border-red-500');
                isValid = false;
            } else {
                field.classList.remove('border-red-500');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('لطفاً تمام فیلدهای الزامی را پر کنید');
        }
    });
    
    // Real-time validation
    const nationalIdInput = document.querySelector('input[name="national_id"]');
    if (nationalIdInput) {
        nationalIdInput.addEventListener('input', function() {
            const value = this.value.replace(/\D/g, ''); // Remove non-digits
            this.value = value;
            
            if (value.length === 10) {
                this.classList.remove('border-red-500');
                this.classList.add('border-green-500');
            } else if (value.length > 0) {
                this.classList.remove('border-green-500');
                this.classList.add('border-red-500');
            } else {
                this.classList.remove('border-red-500', 'border-green-500');
            }
        });
    }
    
    // Phone number formatting
    const phoneInput = document.querySelector('input[name="phone"]');
    if (phoneInput) {
        phoneInput.addEventListener('input', function() {
            let value = this.value.replace(/\D/g, '');
            if (value.length > 0) {
                if (value.startsWith('0')) {
                    value = value.substring(1);
                }
                if (value.length >= 10) {
                    value = value.substring(0, 10);
                }
                this.value = value;
            }
        });
    }
});
</script>
<script>
// Persian datepicker for birth_date (direct Jalali storage)
$(function(){
    var $birthDateInput = $('input[name="birth_date"]');
    if (!$birthDateInput.length) return;

    // init Persian datepicker (year/month/day selection)
    $birthDateInput.pDatepicker({
        autoClose: true,
        format: 'YYYY/MM/DD',
        initialValue: !!$birthDateInput.val(),
        initialValueType: 'persian',
        calendar: { persian: { locale: 'fa', leapYearMode: 'astronomical' } },
        toolbox: { calendarSwitch: { enabled: true }, todayButton: { enabled: true, text: 'امروز' } },
        navigator: { enabled: true, scroll: { enabled: true } },
        onSelect: function(unix){
            try {
                var pd = new persianDate(unix);
                var jalaliDate = pd.format('YYYY/MM/DD');
                $birthDateInput.val(jalaliDate);
                console.log('Selected Jalali date:', jalaliDate); // Debug
            } catch(e) {
                console.error('Date selection error:', e);
            }
        }
    });
});
</script>
<!-- Jalali datepicker for birth_date (single visible input) -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jalaali-js@1.2.3/index.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
{% endblock %}
{% endblock %}
